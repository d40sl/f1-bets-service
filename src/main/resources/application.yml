server:
  port: ${SERVER_PORT:8090}

spring:
  application:
    name: f1-bets

  datasource:
    url: ${SPRING_DATASOURCE_URL:jdbc:postgresql://localhost:5432/f1bets}
    username: ${SPRING_DATASOURCE_USERNAME}
    password: ${SPRING_DATASOURCE_PASSWORD}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: ${HIKARI_MAX_POOL_SIZE:10}
      minimum-idle: ${HIKARI_MIN_IDLE:2}
      connection-timeout: ${HIKARI_CONNECTION_TIMEOUT:30000}
      data-source-properties:
        socketTimeout: ${DB_SOCKET_TIMEOUT:30}
        connectTimeout: ${DB_CONNECT_TIMEOUT:10}

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        format_sql: true
      jakarta:
        persistence:
          query:
            timeout: ${JPA_QUERY_TIMEOUT:30000}
    open-in-view: false

  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true

odds:
  seed: ${ODDS_SEED:F1BETS_SEED}

openf1:
  base-url: ${OPENF1_BASE_URL:https://api.openf1.org/v1}
  timeout: ${OPENF1_TIMEOUT:35000}
  cache-ttl: ${OPENF1_CACHE_TTL:180}
  max-sessions: ${OPENF1_MAX_SESSIONS:6}
  driver-delay-ms: ${OPENF1_DRIVER_DELAY_MS:500}

resilience4j:
  circuitbreaker:
    instances:
      openf1:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 3
        register-health-indicator: true
  retry:
    instances:
      openf1:
        max-attempts: 3
        wait-duration: 1s
        exponential-backoff-multiplier: 2
        retry-exceptions:
          - java.io.IOException
          - java.net.SocketTimeoutException
  bulkhead:
    instances:
      openf1:
        max-concurrent-calls: 10
        max-wait-duration: 500ms
  ratelimiter:
    instances:
      api:
        limit-for-period: ${RATE_LIMIT_REQUESTS:100}
        limit-refresh-period: ${RATE_LIMIT_PERIOD:1m}
        timeout-duration: 0s
        register-health-indicator: true

management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus,metrics
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}

logging:
  level:
    com.f1bets: ${LOG_LEVEL_APP:INFO}
    org.springframework.web: ${LOG_LEVEL_SPRING:INFO}
    org.flywaydb: INFO
    io.github.resilience4j: INFO
    org.hibernate.engine.jdbc.spi.SqlExceptionHelper: OFF
  pattern:
    console: "%d{HH:mm:ss.SSS} [%X{requestId}] %-5level %logger{36} - %msg%n"
