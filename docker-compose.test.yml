services:
  test-db:
    image: postgres:16
    environment:
      POSTGRES_DB: f1bets_test
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256 --auth-local=scram-sha-256"
    networks:
      - f1bets-test-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d f1bets_test"]
      interval: 2s
      timeout: 5s
      retries: 10

  test-runner:
    image: maven:3.9-eclipse-temurin-17
    working_dir: /app
    volumes:
      - .:/app
      - maven-cache:/root/.m2
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://test-db:5432/f1bets_test
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
    depends_on:
      test-db:
        condition: service_healthy
    networks:
      - f1bets-test-network
    command: >
      mvn test
      -DuseExternalDb=true
      -Dspring.datasource.url=jdbc:postgresql://test-db:5432/f1bets_test
      -Dspring.datasource.username=postgres
      -Dspring.datasource.password=postgres

networks:
  f1bets-test-network:
    driver: bridge

volumes:
  maven-cache:
